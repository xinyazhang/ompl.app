#/bin/sh
trap kill_celery INT

function kill_celery() {
    for p  in `ps aux |grep omplweb.celery| awk '{print $1 " " $2}'`; do
        kill $p 2>&1 >& /dev/null
    done
}

cd `dirname $0`
if [[ ! -e omplweb.py ]]; then
    if [[ -e ../ompl/webapp/omplweb.py ]]; then
        # assume we are in ${prefix}/bin, cd to ${prefix}/share/ompl/webapp
        cd ../share/ompl/webapp
    else
        echo "Error: cannot find omplweb.py"
    fi
fi

celerystatus=`celery status -q -C -A omplweb.celery 2>&1 | cut -f2 -d " "`
if [[ ! ${celerystatus} == "OK" ]]; then
    celery worker -A omplweb.celery --loglevel=info 2>&1 >& /tmp/omplweb-celery.log &
    python omplweb.py
    kill_celery
else
    echo "Celery is already running an omplweb job queue."
fi
